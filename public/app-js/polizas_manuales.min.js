var dataAsiento=[],dataTipoEntidad=[],dataAsignacionXML=[],dataXMLUsados=[],dataCuentasBancoEmpresa=[],dataEntidades=[],id_asiento=0,nombre_entidad="",dao={getXMLAsignados:function(a){var e=a,o=$("#tblXMLAsociados"),i=[{aTargets:[0],mData:"rfc"},{aTargets:[1],mData:"nombre_entidad"},{aTargets:[2],mData:"uuid"},{aTargets:[3],mData:"total"},{aTargets:[4],mData:"metodo_pago"},{aTargets:[5],mData:"saldo"},{aTargets:[6],mData:null,mRender:function(a){return'<a class="btn btn-sm btn-danger" target="_blank" onclick="dao.deleteXMLAsignado('+a.id+')"><i class="glyphicon glyphicon-remove"></i></a>&nbsp;'}}];_gen.setTableNE(o,i,e),0!=e.length?$("#tblAsociados, #tblAsociadosTitle").show("slow"):$("#tblAsociados, #tblAsociadosTitle").hide()},getXMLUsados:function(a){var e=a,o=$("#tblXMLExistentes"),i=[{aTargets:[0],mData:"rfc"},{aTargets:[1],mData:"uuid"},{aTargets:[2],mData:"total"},{aTargets:[3],mData:"metodo_pago"},{aTargets:[4],mData:"saldo"}];_gen.setTableNE(o,i,e),0!=e.length?$("#tblExistentes, #tblExistentesTitle").show("slow"):$("#tblExistentes,#tblExistentesTitle").hide()},getAsientoContable:function(a){var e=a,o=$("#tblPolizasManuales"),i=[{aTargets:[0],mData:"clave"},{aTargets:[1],mData:"descripcion"},{aTargets:[2],mData:"entidad"},{aTargets:[3],mData:"cargo"},{aTargets:[4],mData:"abono"},{aTargets:[5],mData:null,mRender:function(a){return'<a class="btn btn-sm btn-danger" target="_blank" onclick="dao.deleteAsientoContable('+a.id+')"><i class="glyphicon glyphicon-remove"></i></a>&nbsp;'}}];_gen.setTableNE(o,i,e)},deleteXMLAsignado:function(a){for(var e=0;e<dataAsignacionXML.length;e++)dataAsignacionXML[e].id==a&&(dataAsignacionXML.splice(e,1),0==dataAsignacionXML.length?(dataAsignacionXML=[],dao.getXMLAsignados(dataAsignacionXML)):dao.getXMLAsignados(dataAsignacionXML))},deleteAsientoContable:function(a){for(var e=0;e<dataAsiento.length;e++)dataAsiento[e].id==a&&(dataAsiento.splice(e,1),0==dataAsiento.length?(dataAsiento=[],dao.getAsientoContable(dataAsiento)):dao.getAsientoContable(dataAsiento));dao.TotalesAsiento(dataAsiento);for(var e=0;e<dataEntidades.length;e++)dataEntidades[e].id==a&&(dataEntidades.splice(e,1),0==dataEntidades.length&&(dataEntidades=[]))},TotalesAsiento:function(a){for(var e=0,o=0,i=0,t=0;t<a.length;t++)e=parseFloat(e)+parseFloat(a[t].abono),o=parseFloat(o)+parseFloat(a[t].cargo);i=o-e,$("#total_cargo").val(o),$("#total_abono").val(e),$("#diferencia").val(i),$("#textDiferencia").text(""),o!=e?(o>e&&($("#textDiferencia").text("El Cargo es mayor que el abono"),$("#diferenciaValidacion").show("slow")),e>o&&($("#textDiferencia").text("El Abono es mayor que el cargo"),$("#diferenciaValidacion").show("slow"))):($("#diferenciaValidacion").hide(),$("#textDiferencia").text(""))},CrearPoliza:function(){1==$("#frmPolizaManual").valid()?$.get("/api_cont/cuentas_modificar/"+$("#id_cuenta_contable").val()).done(function(a){""!=nombre_entidad&&"N/A"!=nombre_entidad||(nombre_entidad="N/A");var e={id:id_asiento,entidad:nombre_entidad,tc:$("#tc").val(),id_moneda:$("#id_moneda").val(),fecha_poliza:$("#fecha_poliza").val(),tipo_poliza:$("#tipo_poliza").val(),concepto_poliza:$("#concepto_poliza").val(),id_entidad:$("#id_entidad").val(),id_catalogo_entidad:$("#id_catalogo_entidad").val(),id_cuenta_contable:$("#id_cuenta_contable").val(),clave:a.codigo,descripcion:a.cuenta_contable,cargo:$("#cargo").val(),abono:$("#abono").val()};if(dataAsiento.push(e),dao.TotalesAsiento(dataAsiento),dao.getAsientoContable(dataAsiento),0!=$("#id_catalogo_entidad").val()&&""!=$("#id_entidad").val()&&(0!=dataEntidades.length&&$.each(dataEntidades,function(a){if(dataEntidades[a].id_entidad!=$("#id_entidad").val()||dataEntidades[a].id_catalogo_entidad!=$("#id_catalogo_entidad").val()){var e={id:id_asiento,id_entidad:$("#id_entidad").val(),id_catalogo_entidad:$("#id_catalogo_entidad").val()};dataEntidades.push(e)}}),0==dataEntidades.length)){var o={id:id_asiento,id_entidad:$("#id_entidad").val(),id_catalogo_entidad:$("#id_catalogo_entidad").val()};dataEntidades.push(o)}return $("#contAC").html("").append('<i class="fa fa-file-archive-o"></i>&nbsp;'+dataAsiento.length),$("#contACBadge").html("").append(dataAsiento.length),dao.limpiar(),id_asiento++,!0}):_gen.notificacion_min("Error","No se cumple con todas las validaciones",4)},limpiar:function(){$("#cargo, #abono").val(""),$("#id_cuenta_contable").select2("val","0"),$("#id_cuenta").append($("<option></option>").text("Seleccione una cuenta").val("0")),$("#id_cuenta_contable").focus()},limpiarXMLManual:function(){$("#uuid,#rfc,#monto").val(""),$("#metodo_pago").select2("val",""),$("#rfc").focus()},CuentasBancarias:function(a,e){$.ajax({url:"/api_cont/empresas_bancos/"+localStorage.id_empresa,type:"GET",dataType:"json"}).done(function(o){var i=0;dataCuentasBancoEmpresa=o,a.html(""),a.append($("<option></option>").text("Seleccione una cuenta "+e).val("0")),$.each(o,function(e){a.append('<option value="'+o[e].id+'">'+o[e].num_cuenta+" "+o[e].nombre_corto+"</option>"),"on"==o[e].principal&&(i++,a.select2().select2("val",o[e].id))}),0==i&&a.select2().select2("val","0")}).fail(function(a){_gen.notificacion_min("Error","La operaci&oacute;n no se realiz&oacute; correctamente al parecer est&aacute; intentando ingresar informaci&oacute; no valida","gritter-error")})},CuentasEntidades:function(a,e,o,i){var t="";"proveedores"==e&&(t="/api_cont/proveedores_bancos/"+a),"clientes"==e&&(t="/api_cont/clientes_cuentas/"+a),"empleados"==e&&(t="/api_cont/empleados_cuentas/"+a),$.ajax({url:t,type:"GET",dataType:"json"}).done(function(a){o.html(""),o.append($("<option></option>").text("Seleccione una cuenta "+i).val("0")),$.each(a,function(e){o.append('<option value="'+a[e].id+'">'+a[e].num_cuenta+"</option>")}),o.select2().select2("val","0")}).fail(function(a){_gen.notificacion_min("Error","La operaci&oacute;n no se realiz&oacute; correctamente al parecer est&aacute; intentando ingresar informaci&oacute; no valida","gritter-error")})},GuardarPoliza:function(){if(dataAsiento.length>=2){if("0"==$("#diferencia").val()){var a=0,e=0;"egreso"!=$("#tipo_poliza").val()&&"ingreso"!=$("#tipo_poliza").val()||(a=$("#id_cuenta_origen").val(),e=$("#id_cuenta_destino").val());var o={concepto:$("#concepto_poliza").val(),tipo_documento:$("#tipo_documento").val(),num_documento:$("#num_documento").val(),tipo_cambio:$("#tc").val(),id_moneda:$("#id_moneda").val(),fecha:$("#fecha_poliza").val(),tipo_poliza:$("#tipo_poliza").val(),id_cuenta_origen:a,id_cuenta_destino:e,id_empresa:localStorage.id_empresa,observaciones:$("#observaciones").val(),movimientos_bancarios:$("#movimientos_bancarios").val()},i={poliza:o,asiento_manual:dataAsiento,xml_asociados:dataAsignacionXML};$.ajax({data:i,url:"/api_cont/polizas_manuales",type:"POST",dataType:"json"}).done(function(a){_gen.notificacion_min("Exito","La poliza Manual se a generado con exito",2),window.location.href="/#contabilidad/poliza_manual"})}}else _gen.notificacion_min("Aviso","Es necesario generar un asiento contable para poder guardar la poliza",4)},GuardarPolizaValid:function(){1==dataEntidades.length?"egreso"!=$("#tipo_poliza").val()&&"ingreso"!=$("#tipo_poliza").val()||("0"!=$("#id_cuenta_origen").val()&&"0"!=$("#id_cuenta_destino").val()?dao.GuardarPoliza():_gen.notificacion_min("Aviso","Es necesario seleccionar una cuenta origen y una cuenta destino",4)):dao.GuardarPoliza()},deleteXMLDuplicado:function(a){for(var e=0;e<dataAsignacionXML.length;e++)dataAsignacionXML[e].uuid==a&&(dataAsignacionXML.splice(e,1),0==dataAsignacionXML.length&&(dataAsignacionXML=[]))},deleteXMLUsadosDuplicado:function(a){for(var e=0;e<dataXMLUsados.length;e++)dataXMLUsados[e].uuid==a&&(dataXMLUsados.splice(e,1),0==dataXMLUsados.length&&(dataXMLUsados=[]))}},pagefunction=function(){var a=$(".wizard").wizard();a.on("change",function(a,e){if(1==e.step)return dataAsiento.length>=2?"0"==$("#diferencia").val()?(1==dataEntidades.length?("egreso"==$("#tipo_poliza").val()&&(dao.CuentasBancarias($("#id_cuenta_origen"),"origen"),dao.CuentasEntidades(dataEntidades[0].id_catalogo_entidad,dataEntidades[0].id_entidad,$("#id_cuenta_destino"),"destino")),"ingreso"==$("#tipo_poliza").val()&&(dao.CuentasBancarias($("#id_cuenta_destino"),"destino"),dao.CuentasEntidades(dataEntidades[0].id_catalogo_entidad,dataEntidades[0].id_entidad,$("#id_cuenta_origen"),"origen")),$("#AsignacionCuentasOD").show("slow")):("egreso"!=$("#tipo_poliza").val()&&"ingreso"!=$("#tipo_poliza").val()&&$("#id_cuenta_origen, #id_cuenta_destino").html(""),$("#AsignacionCuentasOD").hide()),!0):(_gen.notificacion_min("Aviso","La diferencia debe ser igual a cero",4),!1):(_gen.notificacion_min("Aviso","Se requieren al menos 2 asientos contables para continuar",4),!1)}).on("finished",function(a,e){dao.GuardarPolizaValid()}).on("stepclick",function(a){return 1==a.step&&$("#btnGuardarA").show(),!1}),Dropzone.autoDiscover=!1,$("#mydropzone").dropzone({init:function(){myDropzone=this,this.on("addedfile",function(a){}),this.on("complete",function(a){0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&(dao.getXMLUsados(dataXMLUsados),dao.getXMLAsignados(dataAsignacionXML)),myDropzone.removeFile(a)}),this.on("success",function(a,e){var o={},i={};"SI"==e.Existe&&(o={uuid:e.uuid,metodo_pago:e.metodo_de_pago,rfc:e.rfc,saldo:e.saldo,total:e.total},dataXMLUsados.push(o),o={}),"NO"==e.Existe&&(i={uuid:e.uuid,nombre_entidad:e.nombre_entidad,metodo_pago:e.metodo_de_pago,rfc:e.rfc,saldo:e.total,total:e.total},dataAsignacionXML.push(i)),$("#contAX").html("").append('<i class="fa fa-file-archive-o"></i>&nbsp;'+dataAsignacionXML.length),$("#contAXBadge").html("").append(dataAsignacionXML.length)})},acceptedFiles:".xml,.XML",autoProcessQueue:!0,addRemoveLinks:!0,maxFilesize:5,uploadMultiple:!1,url:"api_cont/xml_polizas_manuales",method:"POST",dictDefaultMessage:'<span class="text-center"><span class="font-lg visible-xs-block visible-sm-block visible-lg-block"><span class="font-lg"><i class="fa fa-caret-right text-danger"></i> Seleccione los archivos <span class="font-xs">xml</span></span><span>&nbsp&nbsp<h4 class="display-inline"> (Or Click)</h4></span>',dictResponseError:"Error uploading file!"}),$("#id_entidad").change(function(){nombre_entidad="N/A","clientes"==$(this).val()&&_g.listas.getClientesEmpresa(localStorage.id_empresa,$("#id_catalogo_entidad")),"proveedores"==$(this).val()&&_g.listas.getProveedoresEmpresa(localStorage.id_empresa,$("#id_catalogo_entidad")),"empleados"==$(this).val()&&_g.listas.getEmpleadosEmpresa(localStorage.id_empresa,$("#id_catalogo_entidad")),""==$(this).val()?($("#id_cuenta_contable").focus(),$("#id_catalogo_entidad").html(""),$("#id_catalogo_entidad").append($("<option></option>").text("Seleccione").val("0")),$("#id_catalogo_entidad").select2("val","0")):$("#id_catalogo_entidad").focus()}),$("#tc").keypress(function(a){13==a.which&&(0!=localStorage.tc?$.SmartMessageBox({title:"Confirmar",content:"Porfavor confirme que desea usar un tipo de cambio de la cantidad de "+$("#tc").val(),buttons:"[No][Cambiar]"},function(a){return"Cambiar"===a?(localStorage.tc=$("#tc").val(),!0):($("#tc").val(localStorage.tc),$("#id_moneda").focus(),!1)}):localStorage.tc=$("#tc").val(),$("#id_moneda").focus())}),$("#id_moneda").change(function(a){0!=localStorage.id_moneda?$.SmartMessageBox({title:"Confirmar",content:"Porfavor confirme que desea cambiar el tipo de moneda",buttons:"[No][Cambiar]"},function(a){return"Cambiar"===a?(localStorage.id_moneda=$("#id_moneda").val(),"101"==localStorage.id_moneda?($("#tc").val("1"),$("#fecha_poliza").focus()):$("#tc").val("").focus(),!0):($("#id_moneda").select2("val",localStorage.id_moneda),void $("#fecha_poliza").focus())}):(localStorage.id_moneda=$("#id_moneda").val(),$("#fecha_poliza").focus())}),$("#id_moneda").keypress(function(a){13==a.which&&("101"==$(this).val()?$("#fecha_poliza").focus():$.SmartMessageBox({title:"Confirmar",content:"Porfavor confirme que desea cambiar el tipo de moneda",buttons:"[No][Cambiar]"},function(a){return"Cambiar"===a?(localStorage.id_moneda=$("#id_moneda").val(),$("#tc").val("").focus(),!0):($("#id_moneda").select2("val",localStorage.id_moneda),void $("#fecha_poliza").focus())}))}),$("#fecha_poliza").keypress(function(a){13==a.which&&($(this).valid(),$("#tipo_poliza").focus())}),$("#tipo_poliza").change(function(a){$("#concepto_poliza").focus(),$("#tipo_poliza_data").val($(this).val())}),$("#concepto_poliza").keypress(function(a){13==a.which&&$("#id_entidad").focus()}),$("#id_cuenta_contable").change(function(a){nombre_entidad="N/A","clientes"==$("#id_entidad").val()&&"0"!=$("#id_catalogo_entidad").val()&&$.get("/api_cont/info_clientes/"+$("#id_catalogo_entidad").val()).done(function(a){nombre_entidad=a.nombre}),"proveedores"==$("#id_entidad").val()&&"0"!=$("#id_catalogo_entidad").val()&&$.get("/api_cont/info_proveedor/"+$("#id_catalogo_entidad").val()).done(function(a){nombre_entidad=a.nombre}),"empleados"==$("#id_entidad").val()&&"0"!=$("#id_catalogo_entidad").val()&&$.get("/api_cont/info_empleados/"+$("#id_catalogo_entidad").val()).done(function(a){nombre_entidad=a.nombre}),""!=$(this).val()&&$("#cargo").focus()}),$("#cargo").keypress(function(a){13==a.which&&(""==$(this).val()&&($(this).val("0"),$("#abono").focus()),""!=$(this).val()&&"0"!=$(this).val()&&($("#abono").val("0"),dao.CrearPoliza()),a.preventDefault(),$("#cargo").blur())}),$("#abono").keypress(function(a){13==a.which&&("0"==$("#cargo").val()&&"0"==$(this).val()&&(_gen.notificacion_min("Error","Es obligatorio agregar un cargo o abono",4),$("#abono").focus()),"0"!=$(this).val()&&""!=$(this).val()&&($("#cargo").val("0"),dao.CrearPoliza()),a.preventDefault(),$("#abono").blur())}),$("#frmPolizaManual").validate({rules:{tc:{required:!0,number:!0},id_moneda:{required:!0},fecha_poliza:{required:!0,date:!0},tipo_poliza:{required:!0},concepto_poliza:{required:!0},id_cuenta_contable:{required:!0},cargo:{required:!0,number:!0},abono:{required:!0,number:!0}},messages:{tc:{required:"Es obligatorio llenar los datos",number:"Este campo es númerico"},id_moneda:{required:"Es obligatorio llenar los datos"},fecha_poliza:{required:"Es obligatorio llenar los datos",date:"Formato de fecha obligatorio"},tipo_poliza:{required:"Es obligatorio llenar los datos"},concepto_poliza:{required:"Es obligatorio llenar los datos"},id_cuenta_contable:{required:"Es obligatorio llenar los datos"},cargo:{required:"Es obligatorio llenar los datos",number:"Este campo es númerico"},abono:{required:"Es obligatorio llenar los datos",number:"Este campo es númerico"}}}),$("#frmXMLManual").validate({rules:{monto:{required:!0,number:!0},uuid:{required:!0},rfc:{required:!0},metodo_pago:{required:!0}},messages:{monto:{required:"Es obligatorio llenar los datos",number:"Este campo es númerico"},uuid:{required:"Es obligatorio llenar los datos"},rfc:{required:"Es obligatorio llenar los datos"},metodo_pago:{required:"Es obligatorio llenar los datos"}}})};pagefunction(),$(document).ready(function(){null==localStorage.id_empresa&&(_gen.notificacion_min("Error","No existe una empresa asignada para continuar",4),window.location.href="/#contabilidad/poliza_manual"),localStorage.tc=0,localStorage.id_moneda=101,$(".datepickerEs").datepicker({dateFormat:"yy-mm-dd",language:"es"}),$("#id_empresa_data").val(localStorage.id_empresa),$("#tc").focus(),_g.listas.getCatMonedas(),_g.listas.getCatCuentasContableAfectablesTodas(localStorage.id_empresa,$("#id_cuenta_contable")),dao.getAsientoContable(dataAsiento),$("#btnCrearAsiento").click(function(a){dao.CrearPoliza(),a.preventDefault()}),$("#btnSalir").click(function(a){dao.salir(),a.preventDefault()}),$("#btnAgregarXML").click(function(a){if($("#frmXMLManual").valid()){var e={uuid:$("#uuid").val(),nombre_entidad:"N/A",metodo_pago:$("#metodo_pago").val(),rfc:$("#rfc").val(),saldo:$("#monto").val(),total:$("#monto").val()};dataAsignacionXML.push(e),dao.getXMLAsignados(dataAsignacionXML),$("#contAX").html("").append('<i class="fa fa-file-archive-o"></i>&nbsp;'+dataAsignacionXML.length),$("#contAXBadge").html("").append(dataAsignacionXML.length),dao.limpiarXMLManual(),_gen.notificacion_min("Exito","Se agrego el XML de forma correcta",2),a.preventDefault()}}),$("#btnAddObservaciones").click(function(){$("#TextObservaciones").toggle()}),$("#btnNuevaCuenta").click(function(){_g.listas.getCatMonedasCustom($("#id_moneda_m")),_g.listas.getCatBancosCustom($("#id_banco_m")),$("#NuevaCuenta").modal("show"),$("#cuenta").val("")}),$("#btnAgregarCuenta").click(function(a){a.preventDefault(),""!=$("#id_entidad").val()&&""!=$("#id_catalogo_entidad").val()&&""!=$("#id_banco_m").val()&&""!=$("#id_moneda_m").val()&&""!=$("#cuenta_m").val()?("clientes"==$("#id_entidad").val()&&$.post("/api_cont/clientes_cuentas",{id_cliente:$("#id_catalogo_entidad").val(),id_banco:$("#id_banco_m").val(),id_moneda:$("#id_moneda_m").val(),num_cuenta:$("#cuenta_m").val(),principal:$("#principal_m").val()}).done(function(a){_g.listas.getCuentasClientes($("#id_catalogo_entidad").val(),$("#id_cuenta_bancaria")),_gen.notificacion_min("&Eacute;xito","La operaci&oacute;n se realiz&oacute; exitosamente",1),$("#NuevaCuenta").modal("hide")}).fail(function(a){_g.listas.getCuentasClientes($("#id_catalogo_entidad").val(),$("#id_cuenta_bancaria")),_gen.notificacion_min("Error",a.responseText,4),$("#NuevaCuenta").modal("hide")}),"proveedores"==$("#id_entidad").val()&&$.post("/api_cont/proveedores_bancos",{id_proveedor:$("#id_catalogo_entidad").val(),id_banco:$("#id_banco_m").val(),id_moneda:$("#id_moneda_m").val(),num_cuenta:$("#cuenta_m").val(),principal:$("#principal_m").val()}).done(function(a){_g.listas.getCuentasProveedores($("#id_catalogo_entidad").val(),$("#id_cuenta_bancaria")),_gen.notificacion_min("&Eacute;xito","La operaci&oacute;n se realiz&oacute; exitosamente",1),$("#NuevaCuenta").modal("hide")}).fail(function(a){_g.listas.getCuentasProveedores($("#id_catalogo_entidad").val(),$("#id_cuenta_bancaria")),_gen.notificacion_min("Error",a.responseText,4),$("#NuevaCuenta").modal("hide")}),"empleados"==$("#id_entidad").val()&&$.post("/api_cont/empleados_cuentas",{id_empleado:$("#id_catalogo_entidad").val(),id_banco:$("#id_banco_m").val(),id_moneda:$("#id_moneda_m").val(),num_cuenta:$("#cuenta_m").val(),principal:$("#principal_m").val()}).done(function(a){_g.listas.getCuentasEmpleados($("#id_catalogo_entidad").val(),$("#id_cuenta_bancaria")),_gen.notificacion_min("&Eacute;xito","La operaci&oacute;n se realiz&oacute; exitosamente",1),$("#NuevaCuenta").modal("hide")}).fail(function(a){_g.listas.getCuentasEmpleados($("#id_catalogo_entidad").val(),$("#id_cuenta_bancaria")),_gen.notificacion_min("Error",a.responseText,4),$("#NuevaCuenta").modal("hide")})):_gen.notificacion_min("Error","Es necesario llenar los datos",4)})});